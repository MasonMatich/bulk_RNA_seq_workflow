---
params:
  dynamic_title: "Bulk RNA-seq Report"
  params_file: "sample_params"
title: "`r params$dynamic_title`"
author: "Mason Matich (masonmatich@gmail.com)"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: FALSE
---

Many of the figures and analysis methodology were based off of this tutorial from NYU.
https://learn.gencore.bio.nyu.edu/rna-seq-analysis/gene-set-enrichment-analysis/

```{r library_setup, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
# # Library Preparation
# Cran or base R packages required
cranr <- c("bookdown", "dplyr", "DT", "knitr",  "kableExtra", "ashr", "htmltools", "ggplot2", "PCAtools", "knitrBootstrap", "stringr")

# Check if the packages are installed if not install
cranr.new <- cranr[!(cranr%in%installed.packages())]
if (length(cranr.new)) {
  install.packages(cranr.new)
}

# List of bioconductor packages required
bioconductor<-c("ReactomePA", "clusterProfiler", "DESeq2", "GOSemSim", "sva", "vsn", "org.Ce.eg.db", "EnhancedVolcano")

# Check if the packages were installed if not install
bioconductor.new <- bioconductor[!(bioconductor%in%installed.packages())]
if (length(bioconductor.new)) {
  if (!requireNamespace("BiocManager")) {
    install.packages("BiocManager")
  }
  BiocManager::install(bioconductor.new, type="source")
}
# load required packages
sapply(cranr, library, character.only = TRUE)
sapply(bioconductor, library, character.only = TRUE)
```
```{r warning=FALSE, message=FALSE, echo=FALSE}
rm(bioconductor, bioconductor.new, cranr, cranr.new)
```

```{r function_setup, warning=FALSE, message=FALSE, echo=FALSE}
# # Read in functions
source("scripts/translateBioIDs.R")
source("scripts/callClusterProfilerFunc.R")
source("scripts/compileReport.R")
source("scripts/emptyTableMessage.R")
source("scripts/visualizePCsByCondition.R")
source("scripts/knitDataTable.R")
```

```{r datatable_dependencies, warning=FALSE, message=FALSE, include=FALSE}
# Loads dependences needed to render other datatables
DT::datatable(data.frame(x = c(1), y = c(1)), extensions = 'Buttons', rownames = FALSE,options = list(buttons = c('copy', 'csv', 'excel', 'pdf')))
```

```{r params_setup, warning=FALSE, message=FALSE, echo=FALSE}
# # Read in Params
all_sample_params <- read.csv(params$params_file)
#all_sample_params <- read.csv("scripts/sampleInfo.csv")
```

# Inputs Received {.title}
Information received from the csv samplesheet:
```{r report_inputs, warning=FALSE, message=FALSE, echo=FALSE}
datatable(as.data.frame(all_sample_params), rownames = FALSE, options = list(dom = "rt", scrollX = TRUE))
```

```{r run_all_samples, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
# Loop through each sample
for (sample_idx in 1:nrow(all_sample_params)) {
  
  # Set parameters for this iteration
  sample_params <- all_sample_params[sample_idx, ]
  metadata <- read.table(trimws(sample_params$metadata_file_path), header = T)
  
  # Render the child document
  res <- knitr::knit_child(
    'scripts/analysis.Rmd',
    envir = environment(),
    quiet = TRUE
  )
  
  cat(res, sep = '\n')
}
```

```{r cleanup_3, warning=FALSE, message=FALSE, echo=FALSE}
rm(contrasts, results, dds.for.analysis, gene.reference, i, sample_params, callClusterProfilerFunc, compileReport, translateBioIDs, emptyTableMessage, knitDataTable, visualizePCsByCondition)
```

