---
params:
  dynamic_title: "Bulk RNA-seq Report"
  project: 
  params_file: "sample_params"
title: "`r params$dynamic_title`"
author: "Mason Matich (masonmatich@gmail.com)"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: FALSE
---

Many of the figures and analysis methodology were based off of this tutorial from NYU.
https://learn.gencore.bio.nyu.edu/rna-seq-analysis/gene-set-enrichment-analysis/

```{r library_setup, warning=FALSE, message=FALSE, results='hide', echo=FALSE}
# # Library Preparation
# Cran or base R packages required
cranr <- c("bookdown", "dplyr", "DT", "knitr",  "kableExtra", "ashr", "htmltools", "ggplot2", "PCAtools", "knitrBootstrap", "stringr")

# Check if the packages are installed if not install
cranr.new <- cranr[!(cranr%in%installed.packages())]
if (length(cranr.new)) {
  install.packages(cranr.new)
}

# List of bioconductor packages required
bioconductor<-c("ReactomePA", "clusterProfiler", "DESeq2", "GOSemSim", "sva", "vsn", "org.Ce.eg.db", "EnhancedVolcano", "rrvgo")

# Check if the packages were installed if not install
bioconductor.new <- bioconductor[!(bioconductor%in%installed.packages())]
if (length(bioconductor.new)) {
  if (!requireNamespace("BiocManager")) {
    install.packages("BiocManager")
  }
  BiocManager::install(bioconductor.new, type="source")
}
# load required packages
sapply(cranr, library, character.only = TRUE)
sapply(bioconductor, library, character.only = TRUE)
```
```{r warning=FALSE, message=FALSE, echo=FALSE}
rm(bioconductor, bioconductor.new, cranr, cranr.new)
```

```{r dependencies, warning=FALSE, message=FALSE, include=FALSE}
# Loads dependences needed to render other datatables
DT::datatable(data.frame(x = c(1), y = c(1)), extensions = 'Buttons', rownames = FALSE,options = list(buttons = c('copy', 'csv', 'excel', 'pdf')))

# # Create object with GO data for measuring semantic similarity (rrvgo)
semantic_data <- GOSemSim::godata(org.Ce.eg.db, ont="BP", keytype = "ENTREZID")
```

```{r params_setup, warning=FALSE, message=FALSE, echo=FALSE}
# # Read in Params
# sample_params <- read.csv("scripts/inputs/sampleInfo.csv")
# metadata <- read.table("scripts/inputs/chen_phillips_metadata.txt", header = T)
sample_params <- read.csv(params$params_file)
```

```{r function_setup, warning=FALSE, message=FALSE, echo=FALSE}
# # Read in functions
source("scripts/translateBioIDs.R")
source("scripts/callClusterProfilerFunc.R")
source("scripts/compileReport.R")
source("scripts/emptyTableMessage.R")
source("scripts/visualizePCsByCondition.R")
source("scripts/knitDataTable.R")
source("scripts/reduceGORedundancy.R")
source("scripts/DEAnalysis.R")
source("scripts/PCAAnalysis.R")
```

```{r compile_report, warning=FALSE, message=FALSE, echo=FALSE}
for (i in 1:nrow(sample_params)){
  
  knitr::asis_output()
  # Report Inputs
  single.dataset <- sample_params[i,]
  cat("\n\n## Inputs Received\n\nInformation received from the csv samplesheet:\n\n")
  datatable(single.dataset, rownames = FALSE, options = list(dom = "rt", scrollX = TRUE))
  cat("Metadata information received from the tsv table:\n\n")
  
  metadata <- read.table(trimws(single.dataset$metadata), header = T)
  knitr::kable(metadata)
  
  # Run DEG analysis with DESeq2
  DE.results <- DEAnalysis(
    dataset = single.dataset
  )
  
  # Run PCA with PCAtools
  PCAAnalysis(
    dataset = single.dataset,
    metadata = DE.results[["metadata"]],
    rld = DE.results[["rld"]],
    batch.rld = DE.results[["batch correct rld"]]
  )
  
  # Run Cluster Profiler and report results
  for (i in names(DE.results[["results"]])){
    compileReport(
      result.obj = DE.results[["results"]][[i]], 
      contrast = i, 
      l2fc_filter = 0.8,
      padj_filter = 0.1)
  }
  
  # Cleanup
  rm(single.dataset, DE.results)
}
```

```{r cleanup, warning=FALSE, message=FALSE, echo=FALSE}
rm(contrasts, results, dds.for.analysis, gene.reference, i, sample_params, callClusterProfilerFunc, compileReport, translateBioIDs, emptyTableMessage, knitDataTable, visualizePCsByCondition)
```